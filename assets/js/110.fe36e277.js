(window.webpackJsonp=window.webpackJsonp||[]).push([[110],{712:function(e,a,t){"use strict";t.r(a);var c=t(0),o=Object(c.a)({},(function(){var e=this,a=e.$createElement,t=e._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("h1",{attrs:{id:"token-let-players-set-a-wager"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#token-let-players-set-a-wager"}},[e._v("#")]),e._v(" Token - Let Players Set a Wager")]),e._v(" "),t("HighlightBox",{attrs:{type:"synopsis"}},[t("p",[e._v("Make sure you have all you need before proceeding:")]),e._v(" "),t("ul",[t("li",[e._v("You understand the concepts of "),t("RouterLink",{attrs:{to:"/academy/2-main-concepts/modules.html"}},[e._v("modules")]),e._v("), "),t("RouterLink",{attrs:{to:"/academy/2-main-concepts/multistore-keepers.html"}},[e._v("keepers")]),e._v(", and "),t("RouterLink",{attrs:{to:"/academy/2-main-concepts/protobuf.html"}},[e._v("Protobuf")]),e._v(".")],1),e._v(" "),t("li",[e._v("Have Go installed.")]),e._v(" "),t("li",[e._v("The checkers blockchain codebase up to game expiry handling. You can get there by following the "),t("RouterLink",{attrs:{to:"/academy/4-my-own-chain/game-forfeit.html"}},[e._v("previous steps")]),e._v(" or checking out "),t("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/tree/forfeit-game",target:"_blank",rel:"noopener noreferrer"}},[e._v("the relevant version"),t("OutboundLink")],1),e._v(".")],1)])]),e._v(" "),t("p",[e._v("With the introduction of a game expiry in the "),t("RouterLink",{attrs:{to:"/academy/4-my-own-chain/game-forfeit.html"}},[e._v("previous section")]),e._v(" and others you have now addressed the cases when two players start a game and finish it or let it expire.")],1),e._v(" "),t("p",[e._v("In this section you will add an extra layer to a game with wagers or stakes. Your application already includes all the necessary modules. This section relies on the "),t("code",[e._v("bank")]),e._v(" module in particular.")]),e._v(" "),t("p",[e._v("Players choose to wager "),t("em",[e._v("money")]),e._v(" or not, and the winner gets both wagers. The forfeiter loses their wager. To reduce complexity start by letting players wager in the staking token of your application.")]),e._v(" "),t("h2",{attrs:{id:"new-information"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#new-information"}},[e._v("#")]),e._v(" New information")]),e._v(" "),t("p",[e._v("Add this wager value to the "),t("code",[e._v("StoredGame")]),e._v("'s Protobuf definition:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"protobuf",base64:"bWVzc2FnZSBTdG9yZWRHYW1lIHsKICAgIC4uLgogICAgdWludDY0IHdhZ2VyID0gMTI7Cn0K",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/a8e8cdfe3f02697495f15d2348ed960635f32dc3/proto/checkers/stored_game.proto#L20"}}),e._v(" "),t("p",[e._v("You can let players choose the wager they want by adding a dedicated field in the message to create a game, in "),t("code",[e._v("proto/checkers/tx.proto")]),e._v(":")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"protobuf",base64:"bWVzc2FnZSBNc2dDcmVhdGVHYW1lIHsKICAgIC4uLgogICAgdWludDY0IHdhZ2VyID0gNDsKfQo=",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/a8e8cdfe3f02697495f15d2348ed960635f32dc3/proto/checkers/tx.proto#L45"}}),e._v(" "),t("p",[e._v("To have Ignite CLI and Protobuf recompile these two files, you can use:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBpZ25pdGUgZ2VuZXJhdGUgcHJvdG8tZ28K"}}),e._v(" "),t("p",[e._v("Now add a helper function to "),t("code",[e._v("StoredGame")]),e._v(" using the Cosmos SDK "),t("code",[e._v("Coin")]),e._v(" in "),t("code",[e._v("full_game.go")]),e._v(". It encapsulates information about the wager:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyAoc3RvcmVkR2FtZSAqU3RvcmVkR2FtZSkgR2V0V2FnZXJDb2luKCkgKHdhZ2VyIHNkay5Db2luKSB7CiAgICByZXR1cm4gc2RrLk5ld0NvaW4oc2RrLkRlZmF1bHRCb25kRGVub20sIHNkay5OZXdJbnQoaW50NjQoc3RvcmVkR2FtZS5XYWdlcikpKQp9Cg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/a8e8cdfe3f02697495f15d2348ed960635f32dc3/x/checkers/types/full_game.go#L71-L73"}}),e._v(" "),t("p",[e._v("Where "),t("code",[e._v("sdk.DefaultBondDenom")]),e._v(" is most likely "),t("code",[e._v('"stake"')]),e._v(".")]),e._v(" "),t("h2",{attrs:{id:"saving-the-wager"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#saving-the-wager"}},[e._v("#")]),e._v(" Saving the wager")]),e._v(" "),t("p",[e._v("Time to make sure that the new field is saved in the storage and it is part of the creation event.")]),e._v(" "),t("ol",[t("li",[t("p",[e._v("First, define a new event key as a constant:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"Y29uc3QgKAogICAgU3RvcmVkR2FtZUV2ZW50V2FnZXIgPSAmcXVvdDtXYWdlciZxdW90OwopCg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/a8e8cdfe3f02697495f15d2348ed960635f32dc3/x/checkers/types/keys.go#L49"}})],1),e._v(" "),t("li",[t("p",[e._v("Next set the actual value in the new "),t("code",[e._v("StoredGame")]),e._v(" as it is instantiated in the create game handler:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"c3RvcmVkR2FtZSA6PSB0eXBlcy5TdG9yZWRHYW1lewogICAgLi4uCiAgICBXYWdlcjogbXNnLldhZ2VyLAp9Cg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/a8e8cdfe3f02697495f15d2348ed960635f32dc3/x/checkers/keeper/msg_server_create_game.go#L29"}})],1),e._v(" "),t("li",[t("p",[e._v("And in the event:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"Y3R4LkV2ZW50TWFuYWdlcigpLkVtaXRFdmVudCgKICAgIHNkay5OZXdFdmVudChzZGsuRXZlbnRUeXBlTWVzc2FnZSwKICAgICAgICAuLi4KICAgICAgICBzZGsuTmV3QXR0cmlidXRlKHR5cGVzLlN0b3JlZEdhbWVFdmVudFdhZ2VyLCBzdHJjb252LkZvcm1hdFVpbnQobXNnLldhZ2VyLCAxMCkpLAogICAgKQopCg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/a8e8cdfe3f02697495f15d2348ed960635f32dc3/x/checkers/keeper/msg_server_create_game.go#L50"}})],1),e._v(" "),t("li",[t("p",[e._v("Also modify the constructor among the interface definition of "),t("code",[e._v("MsgCreateGame")]),e._v(" in "),t("code",[e._v("x/checkers/types/message_create_game.go")]),e._v(" to avoid surprises:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyBOZXdNc2dDcmVhdGVHYW1lKGNyZWF0b3Igc3RyaW5nLCByZWQgc3RyaW5nLCBibGFjayBzdHJpbmcsIHdhZ2VyIHVpbnQ2NCkgKk1zZ0NyZWF0ZUdhbWUgewogICAgcmV0dXJuICZhbXA7TXNnQ3JlYXRlR2FtZXsKICAgICAgICAuLi4KICAgICAgICBXYWdlcjogd2FnZXIsCiAgICB9Cn0K",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/a8e8cdfe3f02697495f15d2348ed960635f32dc3/x/checkers/types/message_create_game.go#L15"}})],1)]),e._v(" "),t("h2",{attrs:{id:"declaring-expectations"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#declaring-expectations"}},[e._v("#")]),e._v(" Declaring expectations")]),e._v(" "),t("p",[e._v("On its own the "),t("code",[e._v("Wager")]),e._v(" field does not make players pay the wager or receive rewards. You need to add the handling actions. These handling actions must ask the "),t("code",[e._v("bank")]),e._v(" module to perform the required token transfers. For that your keeper needs to ask for a "),t("code",[e._v("bank")]),e._v(" instance during setup.")]),e._v(" "),t("HighlightBox",{attrs:{type:"info"}},[t("p",[e._v("Remember the only way to have access to a capability with the object-capability model of the Cosmos SDK, is to be given the reference to an instance which already has this capability.")])]),e._v(" "),t("p",[e._v("Implement payment handling by having your keeper hold wagers in escrow while the game is being played. The "),t("code",[e._v("bank")]),e._v(" module has functions to transfer tokens from any account to your module and vice-versa.")]),e._v(" "),t("HighlightBox",{attrs:{type:"tip"}},[t("p",[e._v("It is best practice to to declare an interface that narrowly declares the functions from other modules that you expect for your module. The conventional file for these declarations is "),t("code",[e._v("x/checkers/types/expected_keepers.go")]),e._v(".")])]),e._v(" "),t("p",[e._v("The "),t("code",[e._v("bank")]),e._v(" module is capable of a lot but all you need here are two of the "),t("code",[e._v("bank")]),e._v("'s functions. So you "),t("em",[e._v("redeclare")]),e._v(" the functions like so:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"dHlwZSBCYW5rS2VlcGVyIGludGVyZmFjZSB7CiAgICBTZW5kQ29pbnNGcm9tTW9kdWxlVG9BY2NvdW50KGN0eCBzZGsuQ29udGV4dCwgc2VuZGVyTW9kdWxlIHN0cmluZywgcmVjaXBpZW50QWRkciBzZGsuQWNjQWRkcmVzcywgYW10IHNkay5Db2lucykgZXJyb3IKICAgIFNlbmRDb2luc0Zyb21BY2NvdW50VG9Nb2R1bGUoY3R4IHNkay5Db250ZXh0LCBzZW5kZXJBZGRyIHNkay5BY2NBZGRyZXNzLCByZWNpcGllbnRNb2R1bGUgc3RyaW5nLCBhbXQgc2RrLkNvaW5zKSBlcnJvcgp9Cg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/a8e8cdfe3f02697495f15d2348ed960635f32dc3/x/checkers/types/expected_keepers.go#L7-L10"}}),e._v(" "),t("p",[e._v("These two functions must exactly match the functions declared in the "),t("a",{attrs:{href:"https://github.com/cosmos/cosmos-sdk/blob/8b78406/x/bank/keeper/keeper.go#L37-L39",target:"_blank",rel:"noopener noreferrer"}},[t("code",[e._v("bank")]),e._v("'s keeper.go file"),t("OutboundLink")],1),e._v(". Copy the file. Any object with these two functions is a "),t("code",[e._v("BankKeeper")]),e._v(".")]),e._v(" "),t("h2",{attrs:{id:"obtaining-the-capability"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#obtaining-the-capability"}},[e._v("#")]),e._v(" Obtaining the capability")]),e._v(" "),t("p",[e._v("With your requirements declared it is time to make sure your keeper receives a reference to a bank keeper. First add a "),t("code",[e._v("BankKeeper")]),e._v(" to your keeper in "),t("code",[e._v("x/checkers/keeper/keeper.go")]),e._v(":")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"dHlwZSAoCiAgICBLZWVwZXIgc3RydWN0IHsKICAgICAgICBiYW5rIHR5cGVzLkJhbmtLZWVwZXIKICAgICAgICAuLi4KICAgIH0KKQo=",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/a8e8cdfe3f02697495f15d2348ed960635f32dc3/x/checkers/keeper/keeper.go#L16"}}),e._v(" "),t("p",[e._v("This "),t("code",[e._v("BankKeeper")]),e._v(" is your newly declared narrow interface. Do not forget to adjust the constructor accordingly:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyBOZXdLZWVwZXIoCiAgICBiYW5rIHR5cGVzLkJhbmtLZWVwZXIsCiAgICAuLi4KKSAqS2VlcGVyIHsKICAgIHJldHVybiAmYW1wO0tlZXBlcnsKICAgICAgICBiYW5rOiBiYW5rLAogICAgICAgIC4uLgogICAgfQp9Cg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/a8e8cdfe3f02697495f15d2348ed960635f32dc3/x/checkers/keeper/keeper.go#L25-L41"}}),e._v(" "),t("p",[e._v("Finally you need to update where the constructor is called and pass a proper instance of bank keeper. This happens in "),t("code",[e._v("app/app.go")]),e._v(":")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"YXBwLkNoZWNrZXJzS2VlcGVyID0gKmNoZWNrZXJzbW9kdWxla2VlcGVyLk5ld0tlZXBlcigKICAgIGFwcC5CYW5rS2VlcGVyLAogICAgLi4uCikK",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/a8e8cdfe3f02697495f15d2348ed960635f32dc3/app/app.go#L341-L342"}}),e._v(" "),t("p",[e._v("This "),t("code",[e._v("app.BankKeeper")]),e._v(" is a full "),t("code",[e._v("bank")]),e._v(" keeper that also conforms to your "),t("code",[e._v("BankKeeper")]),e._v(" interface because you mastered that copy and paste move.")]),e._v(" "),t("h2",{attrs:{id:"preparing-expected-errors"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#preparing-expected-errors"}},[e._v("#")]),e._v(" Preparing expected errors")]),e._v(" "),t("p",[e._v("There are several new error situations which you can enumerate with new variables:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"RXJyUmVkQ2Fubm90UGF5ICAgICAgPSBzZGtlcnJvcnMuUmVnaXN0ZXIoTW9kdWxlTmFtZSwgMTExMiwgJnF1b3Q7cmVkIGNhbm5vdCBwYXkgdGhlIHdhZ2VyJnF1b3Q7KQpFcnJCbGFja0Nhbm5vdFBheSAgICA9IHNka2Vycm9ycy5SZWdpc3RlcihNb2R1bGVOYW1lLCAxMTEzLCAmcXVvdDtibGFjayBjYW5ub3QgcGF5IHRoZSB3YWdlciZxdW90OykKRXJyTm90aGluZ1RvUGF5ICAgICAgPSBzZGtlcnJvcnMuUmVnaXN0ZXIoTW9kdWxlTmFtZSwgMTExNSwgJnF1b3Q7dGhlcmUgaXMgbm90aGluZyB0byBwYXksIHNob3VsZCBub3QgaGF2ZSBiZWVuIGNhbGxlZCZxdW90OykKRXJyQ2Fubm90UmVmdW5kV2FnZXIgPSBzZGtlcnJvcnMuUmVnaXN0ZXIoTW9kdWxlTmFtZSwgMTExNiwgJnF1b3Q7Y2Fubm90IHJlZnVuZCB3YWdlciB0bzogJXMmcXVvdDspCkVyckNhbm5vdFBheVdpbm5pbmdzID0gc2RrZXJyb3JzLlJlZ2lzdGVyKE1vZHVsZU5hbWUsIDExMTcsICZxdW90O2Nhbm5vdCBwYXkgd2lubmluZ3MgdG8gd2lubmVyJnF1b3Q7KQpFcnJOb3RJblJlZnVuZFN0YXRlICA9IHNka2Vycm9ycy5SZWdpc3RlcihNb2R1bGVOYW1lLCAxMTE4LCAmcXVvdDtnYW1lIGlzIG5vdCBpbiBhIHN0YXRlIHRvIHJlZnVuZCwgbW92ZSBjb3VudDogJWQmcXVvdDspCg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/a8e8cdfe3f02697495f15d2348ed960635f32dc3/x/checkers/types/errors.go#L23-L29"}}),e._v(" "),t("h2",{attrs:{id:"money-handling-steps"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#money-handling-steps"}},[e._v("#")]),e._v(" Money handling steps")]),e._v(" "),t("p",[e._v("With the "),t("code",[e._v("bank")]),e._v(" now in your keeper it is time to have your keeper handle the money. Keep this concern in its own file as the keeper is reused on a play, reject, and forfeit.")]),e._v(" "),t("p",[e._v("Create the new file "),t("code",[e._v("x/checkers/keeper/wager_handler.go")]),e._v(" and add three functions to collect a wager, refund a wager, and pay winnings:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyAoayAqS2VlcGVyKSBDb2xsZWN0V2FnZXIoY3R4IHNkay5Db250ZXh0LCBzdG9yZWRHYW1lICp0eXBlcy5TdG9yZWRHYW1lKSBlcnJvcgpmdW5jIChrICpLZWVwZXIpIE11c3RQYXlXaW5uaW5ncyhjdHggc2RrLkNvbnRleHQsIHN0b3JlZEdhbWUgKnR5cGVzLlN0b3JlZEdhbWUpCmZ1bmMgKGsgKktlZXBlcikgTXVzdFJlZnVuZFdhZ2VyKGN0eCBzZGsuQ29udGV4dCwgc3RvcmVkR2FtZSAqdHlwZXMuU3RvcmVkR2FtZSkK",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/a8e8cdfe3f02697495f15d2348ed960635f32dc3/x/checkers/keeper/wager_handler.go"}}),e._v(" "),t("p",[e._v("The "),t("code",[e._v("Must")]),e._v(" prefix in the function means that the transaction either takes place or a panic is issued. If a player cannot pay the wager, it is a user-side error and the user must be informed of a failed transaction. If the module cannot pay, it means the escrow account has failed. This error is much more serious. An invariant has been violated and the whole application must be terminated.")]),e._v(" "),t("p",[e._v("Now it is time to set up collecting a wager, paying winnings, and refunding a wager:")]),e._v(" "),t("ol",[t("li",[t("p",[t("strong",[e._v("Collecting wagers")]),e._v(" happens on a player's first move. Therefore, differentiate between players:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"aWYgc3RvcmVkR2FtZS5Nb3ZlQ291bnQgPT0gMCB7CiAgICAvLyBCbGFjayBwbGF5cyBmaXJzdAp9IGVsc2UgaWYgc3RvcmVkR2FtZS5Nb3ZlQ291bnQgPT0gMSB7CiAgICAvLyBSZWQgcGxheXMgc2Vjb25kCn0KcmV0dXJuIG5pbAo=",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/a8e8cdfe3f02697495f15d2348ed960635f32dc3/x/checkers/keeper/wager_handler.go#L15-L36"}}),e._v(" "),t("p",[e._v("Get the address for the black player:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"YmxhY2ssIGVyciA6PSBzdG9yZWRHYW1lLkdldEJsYWNrQWRkcmVzcygpCmlmIGVyciAhPSBuaWwgewogICAgcGFuaWMoZXJyLkVycm9yKCkpCn0K",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/a8e8cdfe3f02697495f15d2348ed960635f32dc3/x/checkers/keeper/wager_handler.go#L17-L20"}}),e._v(" "),t("p",[e._v("Try to transfer into the escrow:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZXJyID0gay5iYW5rLlNlbmRDb2luc0Zyb21BY2NvdW50VG9Nb2R1bGUoY3R4LCBibGFjaywgdHlwZXMuTW9kdWxlTmFtZSwgc2RrLk5ld0NvaW5zKHN0b3JlZEdhbWUuR2V0V2FnZXJDb2luKCkpKQppZiBlcnIgIT0gbmlsIHsKICAgIHJldHVybiBzZGtlcnJvcnMuV3JhcGYoZXJyLCB0eXBlcy5FcnJCbGFja0Nhbm5vdFBheS5FcnJvcigpKQp9Cg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/a8e8cdfe3f02697495f15d2348ed960635f32dc3/x/checkers/keeper/wager_handler.go#L21-L24"}}),e._v(" "),t("p",[e._v("Then do the same for the red player.")])],1),e._v(" "),t("li",[t("p",[t("strong",[e._v("Paying winnings")]),e._v(' takes place when the game has a declared winner. So first get the winner. "No winner" is not an acceptable situation in this '),t("code",[e._v("MustPayWinnings")]),e._v(". The caller of the function must know:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"d2lubmVyQWRkcmVzcywgZm91bmQsIGVyciA6PSBzdG9yZWRHYW1lLkdldFdpbm5lckFkZHJlc3MoKQppZiBlcnIgIT0gbmlsIHsKICAgIHBhbmljKGVyci5FcnJvcigpKQp9CmlmICFmb3VuZCB7CiAgICBwYW5pYyhmbXQuU3ByaW50Zih0eXBlcy5FcnJDYW5ub3RGaW5kV2lubmVyQnlDb2xvci5FcnJvcigpLCBzdG9yZWRHYW1lLldpbm5lcikpCn0K",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/a8e8cdfe3f02697495f15d2348ed960635f32dc3/x/checkers/keeper/wager_handler.go#L42-L48"}}),e._v(" "),t("p",[e._v("Then get the winnings to pay:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"d2lubmluZ3MgOj0gc3RvcmVkR2FtZS5HZXRXYWdlckNvaW4oKQppZiBzdG9yZWRHYW1lLk1vdmVDb3VudCA9PSAwIHsKICAgIHBhbmljKHR5cGVzLkVyck5vdGhpbmdUb1BheS5FcnJvcigpKQp9IGVsc2UgaWYgMSAmbHQ7IHN0b3JlZEdhbWUuTW92ZUNvdW50IHsKICAgIHdpbm5pbmdzID0gd2lubmluZ3MuQWRkKHdpbm5pbmdzKQp9Cg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/a8e8cdfe3f02697495f15d2348ed960635f32dc3/x/checkers/keeper/wager_handler.go#L49-L54"}}),e._v(" "),t("p",[e._v("You double the wager only if the red player has also played and therefore both players have paid their wagers. Then pay the winner:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZXJyID0gay5iYW5rLlNlbmRDb2luc0Zyb21Nb2R1bGVUb0FjY291bnQoY3R4LCB0eXBlcy5Nb2R1bGVOYW1lLCB3aW5uZXJBZGRyZXNzLCBzZGsuTmV3Q29pbnMod2lubmluZ3MpKQppZiBlcnIgIT0gbmlsIHsKICAgIHBhbmljKHR5cGVzLkVyckNhbm5vdFBheVdpbm5pbmdzLkVycm9yKCkpCn0K",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/a8e8cdfe3f02697495f15d2348ed960635f32dc3/x/checkers/keeper/wager_handler.go#L55-L58"}})],1),e._v(" "),t("li",[t("p",[e._v("Finally, "),t("strong",[e._v("refunding wagers")]),e._v(" takes place when the game has partially started, i.e. only one party has paid, or when the game ends in a draw. In this narrow case of "),t("code",[e._v("MustRefundWager")]),e._v(":")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"aWYgc3RvcmVkR2FtZS5Nb3ZlQ291bnQgPT0gMSB7CiAgICAvLyBSZWZ1bmQKfSBlbHNlIGlmIHN0b3JlZEdhbWUuTW92ZUNvdW50ID09IDAgewogICAgLy8gRG8gbm90aGluZwp9IGVsc2UgewogICAgLy8gVE9ETyBJbXBsZW1lbnQgYSBkcmF3IG1lY2hhbmlzbS4KICAgIHBhbmljKGZtdC5TcHJpbnRmKHR5cGVzLkVyck5vdEluUmVmdW5kU3RhdGUuRXJyb3IoKSwgc3RvcmVkR2FtZS5Nb3ZlQ291bnQpKQp9Cg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/a8e8cdfe3f02697495f15d2348ed960635f32dc3/x/checkers/keeper/wager_handler.go#L64-L78"}}),e._v(" "),t("p",[e._v("Refund the black player when there has been a single move:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"YmxhY2ssIGVyciA6PSBzdG9yZWRHYW1lLkdldEJsYWNrQWRkcmVzcygpCmlmIGVyciAhPSBuaWwgewogICAgcGFuaWMoZXJyLkVycm9yKCkpCn0KZXJyID0gay5iYW5rLlNlbmRDb2luc0Zyb21Nb2R1bGVUb0FjY291bnQoY3R4LCB0eXBlcy5Nb2R1bGVOYW1lLCBibGFjaywgc2RrLk5ld0NvaW5zKHN0b3JlZEdhbWUuR2V0V2FnZXJDb2luKCkpKQppZiBlcnIgIT0gbmlsIHsKICAgIHBhbmljKGZtdC5TcHJpbnRmKHR5cGVzLkVyckNhbm5vdFJlZnVuZFdhZ2VyLkVycm9yKCksIHJ1bGVzLkJMQUNLX1BMQVlFUi5Db2xvcikpCn0K",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/a8e8cdfe3f02697495f15d2348ed960635f32dc3/x/checkers/keeper/wager_handler.go#L65-L72"}}),e._v(" "),t("p",[e._v("If the module cannot pay, then it is a panic as the escrow has failed.")])],1)]),e._v(" "),t("h2",{attrs:{id:"insert-wager-handling"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#insert-wager-handling"}},[e._v("#")]),e._v(" Insert wager handling")]),e._v(" "),t("p",[e._v("With the desired steps defined in the wager handling functions, it is time to invoke them at the right places in the message handlers.")]),e._v(" "),t("ol",[t("li",[t("p",[e._v("When a player plays for the first time:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZXJyID0gay5LZWVwZXIuQ29sbGVjdFdhZ2VyKGN0eCwgJmFtcDtzdG9yZWRHYW1lKQppZiBlcnIgIT0gbmlsIHsKICAgIHJldHVybiBuaWwsIGVycgp9Cg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/a8e8cdfe3f02697495f15d2348ed960635f32dc3/x/checkers/keeper/msg_server_play_move.go#L47-L50"}})],1),e._v(" "),t("li",[t("p",[e._v("When a player wins as a result of a move:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"aWYgc3RvcmVkR2FtZS5XaW5uZXIgPT0gcnVsZXMuTk9fUExBWUVSLkNvbG9yIHsKICAgIC4uLgp9IGVsc2UgewogICAgLi4uCiAgICBrLktlZXBlci5NdXN0UGF5V2lubmluZ3MoY3R4LCAmYW1wO3N0b3JlZEdhbWUpCn0K",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/a8e8cdfe3f02697495f15d2348ed960635f32dc3/x/checkers/keeper/msg_server_play_move.go#L75-L82"}})],1),e._v(" "),t("li",[t("p",[e._v("When a player rejects a game:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ay5LZWVwZXIuTXVzdFJlZnVuZFdhZ2VyKGN0eCwgJmFtcDtzdG9yZWRHYW1lKQo=",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/a8e8cdfe3f02697495f15d2348ed960635f32dc3/x/checkers/keeper/msg_server_reject_game.go#L39"}})],1),e._v(" "),t("li",[t("p",[e._v("When a game expires and there is a forfeit. Make sure to only refund or pay full winnings when applicable. The logic needs to be adjusted:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"aWYgZGVhZGxpbmUuQmVmb3JlKGN0eC5CbG9ja1RpbWUoKSkgewogICAgaWYgc3RvcmVkR2FtZS5Nb3ZlQ291bnQgPT0gMCB7CiAgICAgICAgLi4uCiAgICB9IGVsc2UgewogICAgICAgIC4uLgogICAgICAgIGlmIHN0b3JlZEdhbWUuTW92ZUNvdW50ICZsdDs9IDEgewogICAgICAgICAgICBrLk11c3RSZWZ1bmRXYWdlcihjdHgsICZhbXA7c3RvcmVkR2FtZSkKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBrLk11c3RQYXlXaW5uaW5ncyhjdHgsICZhbXA7c3RvcmVkR2FtZSkKICAgICAgICB9CiAgICAgICAgLi4uCiAgICB9Cn0K",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/a8e8cdfe3f02697495f15d2348ed960635f32dc3/x/checkers/keeper/end_block_server_game.go#L54-L58"}})],1)]),e._v(" "),t("h2",{attrs:{id:"next-up"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#next-up"}},[e._v("#")]),e._v(" Next up")]),e._v(" "),t("p",[e._v("You can skip ahead and see how you can integrate "),t("RouterLink",{attrs:{to:"/academy/4-my-own-chain/wager-denom.html"}},[e._v("foreign tokens")]),e._v(" via the use of IBC. Or take a look at the "),t("RouterLink",{attrs:{to:"/academy/4-my-own-chain/gas-meter.html"}},[e._v("next section")]),e._v(" to prevent spam and reward validators proportional to their effort in your checkers blockchain.")],1)],1)}),[],!1,null,null,null);a.default=o.exports}}]);